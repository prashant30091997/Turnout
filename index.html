<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .student-circle {
            transition: all 0.2s ease-in-out;
            -webkit-tap-highlight-color: transparent;
        }
        .student-circle:not(.disabled):hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .student-circle.present {
            background-color: #34D399; /* Emerald 400 */
            color: white;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.5);
        }
        .student-circle.disabled {
            background-color: #E5E7EB; /* Gray 200 */
            color: #9CA3AF; /* Gray 400 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        #submit-btn:disabled {
            cursor: not-allowed;
            background-color: #9CA3AF;
        }
        #message-box {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-4xl">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Attendance Tracker</h1>
            <p class="text-gray-500 mt-1">Select lecture details and mark present students.</p>
        </header>

        <!-- Configuration Inputs -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
             <div>
                <label for="sheet-select" class="block text-sm font-medium text-gray-700 mb-1">Lecture Format</label>
                <select id="sheet-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500"></select>
            </div>
             <div>
                <label for="batch-select" class="block text-sm font-medium text-gray-700 mb-1">Student Batch</label>
                <select id="batch-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500"></select>
            </div>
             <div>
                <label for="lecture-date" class="block text-sm font-medium text-gray-700 mb-1">Lecture Date</label>
                <input type="date" id="lecture-date" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" readonly>
            </div>
            <div>
                <label for="lecture-start-time" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                <input type="time" id="lecture-start-time" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
                <label for="lecture-end-time" class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                <input type="time" id="lecture-end-time" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                 <div>
                    <label for="attendance-by" class="block text-sm font-medium text-gray-700 mb-1">Attendance Taken By</label>
                    <input type="text" id="attendance-by" placeholder="Enter name" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500">
                </div>
                 <div>
                    <label for="lecture-by" class="block text-sm font-medium text-gray-700 mb-1">Lecture Taken By</label>
                    <input type="text" id="lecture-by" placeholder="Enter name" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-4 mb-6 border-t pt-6">
            <span class="text-sm font-medium text-gray-600">Actions for selected batch:</span>
            <button id="select-all-btn" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Select All</button>
            <button id="deselect-all-btn" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Deselect All</button>
        </div>

        <!-- Student Grid -->
        <div id="student-grid" class="grid grid-cols-10 gap-2 sm:gap-3 md:gap-4 mb-8"></div>

        <!-- Submit Button -->
        <div class="flex justify-end items-center border-t pt-6">
             <button id="submit-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200">
                <span id="btn-text">Submit Attendance</span>
                <span id="btn-spinner" class="hidden"><svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span>
            </button>
        </div>
    </main>

    <!-- Floating Message Box -->
    <div id="message-box" class="fixed top-5 right-5 bg-white p-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 pointer-events-none max-w-sm">
        <p id="message-text" class="font-medium"></p>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxq4w7FA0i3fvUtGJg-gXXP58GdKFuMcLMTvNgdFSb_OBZIj40ylDB2O6QxV1jEOLi_/exec';

        const CONFIG = {
            sheets: ["Theory", "Clinical", "Hematology", "Tutorial", "SDL-ECE"],
            batches: {
                'All': { name: 'All Students (1-100)', start: 1, end: 100 },
                'A': { name: 'Batch A (1-50)', start: 1, end: 50 },
                'B': { name: 'Batch B (51-100)', start: 51, end: 100 }
            }
        };

        const studentGrid = document.getElementById('student-grid');
        const dateInput = document.getElementById('lecture-date');
        const startTimeInput = document.getElementById('lecture-start-time');
        const endTimeInput = document.getElementById('lecture-end-time');
        const attendanceByInput = document.getElementById('attendance-by');
        const lectureByInput = document.getElementById('lecture-by');
        const sheetSelect = document.getElementById('sheet-select');
        const batchSelect = document.getElementById('batch-select');
        const submitBtn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const btnSpinner = document.getElementById('btn-spinner');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const selectAllBtn = document.getElementById('select-all-btn');
        const deselectAllBtn = document.getElementById('deselect-all-btn');

        document.addEventListener('DOMContentLoaded', () => {
            populateDropdowns();
            generateStudentGrid();
            setDate();
            updateBatchView(); 

            studentGrid.addEventListener('click', handleCircleClick);
            batchSelect.addEventListener('change', updateBatchView);
            submitBtn.addEventListener('click', handleSubmit);
            selectAllBtn.addEventListener('click', () => selectBatch(true));
            deselectAllBtn.addEventListener('click', () => selectBatch(false));
        });

        function populateDropdowns() {
            CONFIG.sheets.forEach(sheetName => {
                sheetSelect.innerHTML += `<option value="${sheetName}">${sheetName}</option>`;
            });
            Object.keys(CONFIG.batches).forEach(batchKey => {
                batchSelect.innerHTML += `<option value="${batchKey}">${CONFIG.batches[batchKey].name}</option>`;
            });
        }
        
        function generateStudentGrid() {
             for (let i = 1; i <= 100; i++) {
                const circle = document.createElement('div');
                circle.className = 'student-circle flex items-center justify-center h-10 w-10 sm:h-12 sm:w-12 bg-gray-100 rounded-full cursor-pointer font-medium text-gray-600 select-none';
                circle.textContent = i;
                circle.dataset.id = i;
                studentGrid.appendChild(circle);
            }
        }
        
        function setDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
        }
        
        function updateBatchView() {
            const selectedBatchKey = batchSelect.value;
            const batch = CONFIG.batches[selectedBatchKey];

            for(let i = 1; i <= 100; i++) {
                const circle = studentGrid.querySelector(`[data-id='${i}']`);
                const isInBatch = i >= batch.start && i <= batch.end;
                
                if (isInBatch) {
                    circle.classList.remove('disabled');
                } else {
                    circle.classList.add('disabled');
                    circle.classList.remove('present');
                }
            }
        }

        function handleCircleClick(event) {
            const circle = event.target.closest('.student-circle');
            if (circle && !circle.classList.contains('disabled')) {
                circle.classList.toggle('present');
            }
        }

        function selectBatch(isPresent) {
            const selectedBatchKey = batchSelect.value;
            const batch = CONFIG.batches[selectedBatchKey];

            for (let i = batch.start; i <= batch.end; i++) {
                const circle = studentGrid.querySelector(`[data-id='${i}']`);
                if (isPresent) {
                    circle.classList.add('present');
                } else {
                    circle.classList.remove('present');
                }
            }
        }

        async function handleSubmit() {
            // New validation for all fields
            if (!startTimeInput.value || !endTimeInput.value || !attendanceByInput.value || !lectureByInput.value) {
                showMessage('Please fill out all time and name fields.', 'error');
                return;
            }
            if (SCRIPT_URL === 'PASTE_YOUR_WEB_APP_URL_HERE') {
                showMessage('Please configure the SCRIPT_URL in the HTML file.', 'error');
                return;
            }

            const attendance = [];
            for (let i = 1; i <= 100; i++) {
                const circle = studentGrid.querySelector(`[data-id='${i}']`);
                attendance.push(circle.classList.contains('present'));
            }

            // Updated data payload with all the new fields
            const data = {
                sheetName: sheetSelect.value,
                date: dateInput.value,
                startTime: startTimeInput.value,
                endTime: endTimeInput.value,
                batch: batchSelect.value,
                attendance: attendance,
                attendanceBy: attendanceByInput.value,
                lectureBy: lectureByInput.value
            };

            setLoading(true);

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showMessage(result.message, 'success');
                } else {
                    throw new Error(result.message || 'An unknown error occurred.');
                }
            } catch (error) {
                console.error('Error submitting attendance:', error);
                showMessage(`Error: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            submitBtn.disabled = isLoading;
            btnText.classList.toggle('hidden', isLoading);
            btnSpinner.classList.toggle('hidden', !isLoading);
        }
        
        let messageTimeout;
        function showMessage(message, type = 'success') {
            clearTimeout(messageTimeout);
            messageText.textContent = message;
            messageBox.className = 'fixed top-5 right-5 p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300';
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            }
            messageBox.classList.remove('opacity-0', 'translate-y-2');
            messageTimeout = setTimeout(() => {
                messageBox.classList.add('opacity-0', 'translate-y-2');
            }, 4000);
        }
    </script>
</body>
</html>

