<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
        .student-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 0.2rem; max-width: 800px; margin: 0 auto; }
        .student-circle { width: 7.8vw; height: 7.8vw; max-width: 50px; max-height: 50px; min-width: 28px; min-height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; transition: all 0.2s ease; user-select: none; border: 2px solid #e5e7eb; font-size: 3.2vw; }
        @media (min-width: 640px) { .student-circle { font-size: 1rem; } }
        @media (max-width: 400px) { .student-circle { font-size: 0.7rem; } }
        .student-circle.present { background-color: #10B981; color: white; border-color: #059669; }
        .student-circle.not-joined { background-color: #9CA3AF; color: white; cursor: not-allowed; opacity: 0.8; }
        .modal { transition: opacity 0.25s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Course Selection Screen -->
    <div id="course-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8 text-center">
            <h1 class="text-2xl font-bold mb-6">Select Course</h1>
            <div class="space-y-4">
                <button data-course="MBBS" class="course-btn w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-600 transition">MBBS Attendance</button>
                <button data-course="PARAMEDIC" class="course-btn w-full bg-green-500 text-white font-bold py-3 px-4 rounded-md hover:bg-green-600 transition">BSc Paramedic Attendance</button>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
            <h1 class="text-2xl font-bold text-center mb-6">Attendance Login</h1>
            <div class="space-y-4">
                <input type="text" id="login-id" placeholder="Login ID" class="w-full px-4 py-2 border rounded-md">
                <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 border rounded-md">
                <button id="login-button" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600">Login</button>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="app-screen" class="hidden">
        <div class="max-w-4xl mx-auto p-2 sm:p-4">
            <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                <header class="mb-4 flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900" id="app-title">Attendance</h1>
                        <p id="user-info" class="text-gray-500 mt-1"></p>
                    </div>
                    <button id="logout-btn" class="text-sm bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Logout</button>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div id="sheet-select-container">
                        <label for="sheet-select" class="block text-sm font-medium text-gray-700">Lecture Format</label>
                        <select id="sheet-select" class="mt-1 block w-full p-2 border rounded-md"></select>
                    </div>
                    <div id="batch-select-container">
                        <label for="batch-select" class="block text-sm font-medium text-gray-700">Batch</label>
                        <select id="batch-select" class="mt-1 block w-full p-2 border rounded-md"></select>
                    </div>
                    <div>
                        <label for="topic-input" class="block text-sm font-medium text-gray-700">Topic</label>
                        <input type="text" id="topic-input" placeholder="Enter lecture topic" class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                    <div class="flex items-center space-x-2">
                        <div>
                           <label for="start-time" class="block text-sm font-medium">Start Time</label>
                           <input type="time" id="start-time" class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                         <div>
                           <label for="end-time" class="block text-sm font-medium">End Time</label>
                           <input type="time" id="end-time" class="mt-1 block w-full p-2 border rounded-md">
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-4 mb-4 border-t pt-4">
                    <label for="lecture-by" class="block text-sm font-medium text-gray-700">Lecture By:</label>
                    <input type="text" id="lecture-by" class="block w-full p-2 border rounded-md">
                </div>

                <div id="student-grid" class="student-grid p-1 bg-gray-50 rounded-lg"></div>

                <div class="mt-6 flex justify-end">
                    <button id="submit-button" class="bg-green-500 text-white font-bold py-2 px-6 rounded-md hover:bg-green-600">Submit</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="message-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="modal-title" class="text-lg font-medium"></h3>
                <p id="modal-message" class="text-sm text-gray-500 mt-2 px-7 py-3"></p>
                <button id="modal-close" class="px-4 py-2 bg-blue-500 text-white rounded-md w-full">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ---!!!--- USER CONFIGURATION ---!!!---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyjSV7tWZOFH0jlxyCcaqpt1zsikK_hUk15p2urZRY-sbPLBBi3e-YWu7jufHF7ExxS/exec';

        const APP_CONFIG = {
            MBBS: {
                course: 'MBBS',
                title: 'MBBS Attendance',
                totalStudents: 100,
                notJoined: [],
                sheets: ["Theory", "Clinical", "Hematology", "Tutorial", "SDL-ECE"],
                batches: {
                    'All': { name: 'All Students (1-100)', start: 1, end: 100 },
                    'A': { name: 'Batch A (1-50)', start: 1, end: 50 },
                    'B': { name: 'Batch B (51-100)', start: 51, end: 100 }
                },
                showBatches: true
            },
            PARAMEDIC: {
                course: 'PARAMEDIC',
                title: 'BSc Paramedic Attendance',
                totalStudents: 23,
                notJoined: [13, 17, 19],
                sheets: ["Turnout"],
                batches: {},
                showBatches: false
            }
        };
        // ---!!! --- END CONFIGURATION ---!!! ---

        let currentConfig = null;
        let attendance = [];
        let currentUser = null;

        // DOM Elements
        const courseScreen = document.getElementById('course-screen');
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const loginButton = document.getElementById('login-button');
        const logoutBtn = document.getElementById('logout-btn');
        const submitButton = document.getElementById('submit-button');
        const studentGrid = document.getElementById('student-grid');
        // ... other elements
        const appTitle = document.getElementById('app-title');
        const userInfoEl = document.getElementById('user-info');
        const loginIdInput = document.getElementById('login-id');
        const loginPasswordInput = document.getElementById('login-password');
        const sheetSelect = document.getElementById('sheet-select');
        const batchSelect = document.getElementById('batch-select');
        const topicInput = document.getElementById('topic-input');
        const startTimeEl = document.getElementById('start-time');
        const endTimeEl = document.getElementById('end-time');
        const lectureByEl = document.getElementById('lecture-by');
        const sheetSelectContainer = document.getElementById('sheet-select-container');
        const batchSelectContainer = document.getElementById('batch-select-container');
        
        // Modal elements
        const modal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalClose = document.getElementById('modal-close');

        function showMessage(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        modalClose.addEventListener('click', () => modal.classList.add('hidden'));

        document.querySelectorAll('.course-btn').forEach(button => {
            button.addEventListener('click', () => {
                const course = button.dataset.course;
                currentConfig = APP_CONFIG[course];
                courseScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            });
        });

        async function handleLogin() {
            const loginId = loginIdInput.value.trim();
            const password = loginPasswordInput.value.trim();
            if (!loginId || !password) {
                return showMessage('Login Failed', 'Please enter both ID and password.');
            }
            loginButton.textContent = 'Logging in...';
            loginButton.disabled = true;

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'login', loginId, password })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    currentUser = result.user;
                    loginScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    initializeAppUI();
                } else {
                    throw new Error(result.message || 'Invalid credentials.');
                }
            } catch (error) {
                showMessage('Login Error', error.message);
            } finally {
                loginButton.textContent = 'Login';
                loginButton.disabled = false;
            }
        }
        
        function handleLogout() {
            currentUser = null;
            currentConfig = null;
            loginIdInput.value = '';
            loginPasswordInput.value = '';
            appScreen.classList.add('hidden');
            courseScreen.classList.remove('hidden');
        }

        function initializeAppUI() {
            appTitle.textContent = currentConfig.title;
            userInfoEl.textContent = `Logged in as: ${currentUser.name}`;

            // Populate dropdowns
            sheetSelect.innerHTML = currentConfig.sheets.map(s => `<option value="${s}">${s}</option>`).join('');
            if (currentConfig.showBatches) {
                batchSelectContainer.classList.remove('hidden');
                batchSelect.innerHTML = Object.keys(currentConfig.batches).map(key => `<option value="${key}">${currentConfig.batches[key].name}</option>`).join('');
            } else {
                batchSelectContainer.classList.add('hidden');
            }
            
            generateStudentGrid();
        }

        function generateStudentGrid() {
            studentGrid.innerHTML = '';
            attendance = [];
            for (let i = 1; i <= currentConfig.totalStudents; i++) {
                const circle = document.createElement('div');
                circle.className = 'student-circle';
                circle.textContent = i;
                circle.dataset.id = i;

                if (currentConfig.notJoined.includes(i)) {
                    circle.classList.add('not-joined');
                    attendance.push('NJ');
                } else {
                    attendance.push('A'); // Default to Absent
                    circle.addEventListener('click', () => {
                        circle.classList.toggle('present');
                        attendance[i - 1] = circle.classList.contains('present') ? 'P' : 'A';
                    });
                }
                studentGrid.appendChild(circle);
            }
        }
        
        async function handleSubmit() {
            const payload = {
                action: 'submitAttendance',
                course: currentConfig.course,
                sheetName: sheetSelect.value,
                date: new Date().toISOString().slice(0, 10), // YYYY-MM-DD
                startTime: startTimeEl.value,
                endTime: endTimeEl.value,
                topic: topicInput.value.trim(),
                attendance: attendance,
                attendanceBy: currentUser.name,
                lectureBy: lectureByEl.value.trim()
            };

            if (!payload.startTime || !payload.endTime || !payload.topic || !payload.lectureBy) {
                return showMessage('Error', 'Please fill all fields: Topic, Times, and Lecture By.');
            }

            submitButton.textContent = 'Submitting...';
            submitButton.disabled = true;

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showMessage('Success', result.message);
                    generateStudentGrid(); // Reset grid
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showMessage('Submission Error', error.message);
            } finally {
                submitButton.textContent = 'Submit';
                submitButton.disabled = false;
            }
        }

        // Event Listeners
        loginButton.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        submitButton.addEventListener('click', handleSubmit);

    </script>
</body>
</html>

